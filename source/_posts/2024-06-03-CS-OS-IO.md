---
title: 操作系统之网络编程心得
date: 2024-06-03 19:00:47
categories: 操作系统
tags: [操作系统, 网络编程]
description: 
---

操作系统中最慢的部分就是IO：
网络 毫秒级~秒级，HDD 毫秒级，SSD 微秒级，内存 纳秒级

## 减少 内存拷贝 上下文切换

一次数据传输，可能涉及多次内存拷贝，内核与用户态间的拷贝带来系统调用，系统调用需要两次上下文切换。

* 首先，上下文切换需要 几十纳秒 ~ 几微秒，高并发环境容易被累积放大

* 其次，内存拷贝也会消耗CPU资源

### DMA

CPU搬运数据，是利用寄存器一次一个字节地搬。

DMA帮CPU省去在IO设备缓冲区和内核缓冲区之间的数据搬运，但CPU还是要在内核缓冲区和用户缓冲区之间搬运。

一次发送文件，经历 read和write 两次系统调用，四次内存拷贝（磁盘缓冲区-PageCache-用户态缓冲区-socket内核缓冲区-网卡缓冲区）。

### 零拷贝

#### mmap + write

mmap系统调用函数把内核缓冲区里的数据映射到用户空间。

省去在内核缓冲区和用户缓冲区之间搬运数据，变成三次内存拷贝，但 mmap和write 还是要两次系统调用。

#### sendfile

在 Linux 内核版本 2.1 中，提供了一个专门发送文件的系统调用函数sendfile，指定源fd和目的fd,实现一次系统调用，三次内存拷贝。

#### SG-DMA

如果网卡支持 The Scatter-Gather Direct Memory Access 技术，就可以让sendfile系统调用只进行两次内存拷贝。只需要给socket缓冲区传fd和数据长度，就可以直接从PageCache拷贝到网卡缓冲区。

所谓的零拷贝技术，就是没有在内存层面去拷贝数据，全程没有通过 CPU 来搬运数据，所有的数据都是通过 DMA 来进行传输。

